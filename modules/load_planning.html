<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Load Planning</title>
  <link rel="stylesheet" href="../styles.css" />
  <style>
    table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; }
    th, td { border-bottom: 1px solid #444; padding: 0.5rem; text-align: center; }
    th { background: var(--card-color); }
    .row-actions button { width: auto; padding: 0.35rem 0.6rem; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.75rem; }
    .totals { margin-top: 1rem; }
    .pill { display: inline-block; padding: 0.2rem 0.5rem; border-radius: 999px; font-weight: 700; }
    .ok    { background: #2b8a3e; color: #fff; }
    .warn  { background: #e67700; color: #fff; }
    .bad   { background: #c92a2a; color: #fff; }
    .note  { opacity: 0.85; font-size: 0.95rem; }
    .section { background: var(--card-color); border-left: 4px solid var(--primary-color); border-radius: 8px; padding: 1rem; margin-top: 1rem; }
    .tight { margin-top: 0.5rem; }
    input[type="text"] { text-align: right; }
    textarea { width: 100%; min-height: 120px; padding: .6rem; border-radius: 8px; border: 1px solid #444; background: #1b1b1b; color: var(--text-color); }
    .muted { opacity: .7; }
  </style>
</head>
<body>
  <button onclick="goHome()" class="home-button">üè† Home</button>
  <h1>Load Planning</h1>

  <!-- Operating (Basic Aircraft) inputs -->
  <div class="section">
    <h3>Operating (Basic Aircraft)</h3>
    <div class="grid-2">
      <div>
        <label for="opWeight">Operating Weight (lbs)</label>
        <input type="text" id="opWeight" inputmode="numeric" pattern="[0-9]*" placeholder="e.g., 270000">
      </div>
      <div>
        <label for="opMom10k">Operating MOM / 10,000</label>
        <input type="text" id="opMom10k" inputmode="numeric" pattern="[0-9]*" placeholder="e.g., 21500">
      </div>
    </div>
    <p class="note tight">Tip: If you only know Operating CG, multiply by Operating Weight and then divide by 10,000 to get MOM/10,000.</p>
  </div>

  <!-- Payload table -->
  <div class="section">
    <h3>Payload Items</h3>
    <div class="note tight">Enter Left, Right, Station. Weight auto-sums (Left + Right). MOM/10,000 is computed.</div>
    <table id="payloadTable">
      <thead>
        <tr>
          <th>#</th>
          <th>Left (lbs)</th>
          <th>Right (lbs)</th>
          <th>Station (in)</th>
          <th>Weight (lbs)</th>
          <th>MOM / 10,000</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="payloadBody"></tbody>
      <tfoot>
        <tr>
          <th colspan="4" style="text-align:right">Totals:</th>
          <th id="totalWeight">0</th>
          <th id="totalMom10k">0</th>
          <th></th>
        </tr>
      </tfoot>
    </table>
    <div style="margin-top:0.75rem; display:flex; gap:0.5rem; flex-wrap:wrap;">
      <button onclick="addRow()">+ Add Row</button>
      <button onclick="clearAll()">Clear All</button>
    </div>
  </div>

  <!-- Computed outputs -->
  <div class="section">
    <h3>Results</h3>
    <div class="grid-2">
      <div>
        <label>Load CB (in)</label>
        <input type="text" id="loadCB" readonly>
      </div>
      <div>
        <label>Total Payload (lbs)</label>
        <input type="text" id="payloadTotal" readonly>
      </div>
      <div>
        <label>Zero Fuel CG (in)</label>
        <input type="text" id="zfCG" readonly>
      </div>
      <div>
        <label>Zero Fuel %MAC</label>
        <input type="text" id="zfMAC" readonly>
      </div>
    </div>

    <div id="limitsBadge" class="tight"></div>
  </div>

  <!-- Envelope (Non-E/R) -->
  <div class="section">
    <h3>Cargo Weight Loading Envelope ‚Äî Non-E/R</h3>
    <p class="note">This section checks the <strong>payload CG (Load CB)</strong> against the Non-E/R envelope. Add anchor points from the TO chart below (payload lb ‚Üí forward & aft station). Linear interpolation is used between points.</p>

    <div class="grid-3">
      <div>
        <label for="envPayload">Payload to Check (auto-filled)</label>
        <input type="text" id="envPayload" readonly>
      </div>
      <div>
        <label for="envFwd">Forward Limit (FS)</label>
        <input type="text" id="envFwd" readonly>
      </div>
      <div>
        <label for="envAft">Aft Limit (FS)</label>
        <input type="text" id="envAft" readonly>
      </div>
    </div>

    <div id="envBadge" class="tight"></div>

    <h4 class="tight">Envelope Points (paste CSV: payload,fwdFS,aftFS)</h4>
    <textarea id="envCSV" spellcheck="false" class="muted" placeholder="Example lines:
45000,616,945
## Add more lines here using the TO chart‚Ä¶"></textarea>
    <div style="margin-top:.5rem; display:flex; gap:.5rem; flex-wrap:wrap;">
      <button onclick="loadEnvelope()">Load/Update Envelope</button>
      <button onclick="resetEnvelope()">Reset to Seed Example</button>
    </div>
  </div>

  <script>
    // Constants (C-17A per your data)
    const LEMAC = 793.6;     // in
    const MAC   = 309.5;     // in

    // Rounding helpers per your rules
    function r0(n){ return Math.round(Number(n)||0); }            // whole number
    function r1(n){ return Math.round((Number(n)||0)*10)/10; }    // 1 decimal

    // === PAYLOAD TABLE ===
    const tbody = document.getElementById('payloadBody');
    const totalWeightEl = document.getElementById('totalWeight');
    const totalMom10kEl = document.getElementById('totalMom10k');

    const loadCBEl   = document.getElementById('loadCB');
    const zfCGEl     = document.getElementById('zfCG');
    const zfMACEl    = document.getElementById('zfMAC');
    const payloadTotalEl = document.getElementById('payloadTotal');
    const limitsBadge = document.getElementById('limitsBadge');

    const opWeightEl = document.getElementById('opWeight');
    const opMom10kEl = document.getElementById('opMom10k');

    function goHome(){ window.location.href = "../index.html"; }

    function newRow(index){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="row-index">${index}</td>
        <td><input type="text" inputmode="numeric" pattern="[0-9]*" class="inp-left" placeholder="0"></td>
        <td><input type="text" inputmode="numeric" pattern="[0-9]*" class="inp-right" placeholder="0"></td>
        <td><input type="text" inputmode="numeric" pattern="[0-9.]*" class="inp-station" placeholder="0"></td>
        <td class="out-weight">0</td>
        <td class="out-mom10k">0</td>
        <td class="row-actions">
          <button type="button" onclick="removeRow(this)">üóë</button>
        </td>
      `;
      tr.querySelectorAll('input').forEach(inp => inp.addEventListener('input', recalc));
      return tr;
    }

    function renumberRows(){
      [...tbody.querySelectorAll('.row-index')].forEach((cell,i)=>cell.textContent=i+1);
    }

    function addRow(){ tbody.appendChild(newRow(tbody.children.length+1)); recalc(); }
    function removeRow(btn){ const tr=btn.closest('tr'); if(tr){ tr.remove(); renumberRows(); recalc(); } }

    function clearAll(){
      tbody.innerHTML=''; addRow();
      opWeightEl.value=''; opMom10kEl.value='';
      recalc();
    }

    function parseNum(val){
      if(typeof val!=='string') return Number(val)||0;
      return Number(val.replace(/,/g,''))||0;
    }

    // === ENVELOPE (Non-E/R) ===
    // Internal storage of anchor points: [{w,fwd,aft}, ...] sorted by w (payload weight)
    let envelopePts = [];

    // Seed with the single example from your chart
    function seedEnvelope(){
      envelopePts = [{ w: 45000, fwd: 616, aft: 945 }];
      document.getElementById('envCSV').value = "45000,616,945\n";
    }

    function loadEnvelope(){
      const txt = document.getElementById('envCSV').value || '';
      const lines = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean).filter(s=>!s.startsWith('#'));
      const parsed = [];
      for(const line of lines){
        const parts = line.split(',').map(s=>s.trim());
        if(parts.length>=3){
          const w = Number(parts[0]); const f = Number(parts[1]); const a = Number(parts[2]);
          if(Number.isFinite(w) && Number.isFinite(f) && Number.isFinite(a)){
            parsed.push({ w, fwd: f, aft: a });
          }
        }
      }
      parsed.sort((a,b)=>a.w-b.w);
      if(parsed.length<1){
        alert("No valid points found. Keep the format: payload,fwdFS,aftFS");
        return;
      }
      envelopePts = parsed;
      recalc(); // refresh check
    }

    function resetEnvelope(){ seedEnvelope(); recalc(); }

    // Given a payload weight, returns {fwd, aft} by linear interpolation across envelopePts.
    function interpolateEnvelope(payload){
      if(envelopePts.length===0) return null;
      // exact or outside edges
      if(payload <= envelopePts[0].w) return { fwd: envelopePts[0].fwd, aft: envelopePts[0].aft };
      if(payload >= envelopePts[envelopePts.length-1].w) return { fwd: envelopePts[envelopePts.length-1].fwd, aft: envelopePts[envelopePts.length-1].aft };

      // find bracketing points
      for(let i=0;i<envelopePts.length-1;i++){
        const p0=envelopePts[i], p1=envelopePts[i+1];
        if(payload>=p0.w && payload<=p1.w){
          const t = (payload - p0.w) / (p1.w - p0.w);
          const fwd = p0.fwd + t * (p1.fwd - p0.fwd);
          const aft = p0.aft + t * (p1.aft - p0.aft);
          return { fwd, aft };
        }
      }
      return null;
    }

    // === RECALC CORE ===
    function recalc(){
      let totalWeight=0;
      let totalMom10k=0;

      [...tbody.querySelectorAll('tr')].forEach(tr=>{
        const left=parseNum(tr.querySelector('.inp-left').value);
        const right=parseNum(tr.querySelector('.inp-right').value);
        const station=parseNum(tr.querySelector('.inp-station').value);

        const weight = r0(left+right);
        const mom10k = r0((weight * station) / 10000);

        tr.querySelector('.out-weight').textContent = weight.toLocaleString();
        tr.querySelector('.out-mom10k').textContent = mom10k.toLocaleString();

        totalWeight += weight;
        totalMom10k += mom10k;
      });

      totalWeightEl.textContent = totalWeight.toLocaleString();
      totalMom10kEl.textContent = totalMom10k.toLocaleString();
      payloadTotalEl.value = totalWeight.toLocaleString();

      // Load CB (payload CG)
      const totalMom = totalMom10k * 10000;
      const loadCB   = totalWeight>0 ? totalMom/totalWeight : 0;
      loadCBEl.value = totalWeight>0 ? r1(loadCB).toFixed(1) : '';

      // Zero Fuel CG / %MAC
      const opW   = parseNum(opWeightEl.value);
      const opM10 = parseNum(opMom10kEl.value);
      const opMom = opM10 * 10000;

      const zfW   = opW + totalWeight;
      const zfMom = opMom + totalMom;
      const zfCG  = zfW>0 ? zfMom / zfW : 0;

      zfCGEl.value  = zfW>0 ? r1(zfCG).toFixed(1) : '';
      const macPct  = zfW>0 ? ((zfCG - LEMAC) / MAC) * 100 : 0;
      zfMACEl.value = zfW>0 ? r1(macPct).toFixed(1) : '';

      // Envelope check (Non-E/R) against Load CB
      const envPayloadEl = document.getElementById('envPayload');
      const envFwdEl     = document.getElementById('envFwd');
      const envAftEl     = document.getElementById('envAft');
      const envBadge     = document.getElementById('envBadge');

      envPayloadEl.value = totalWeight>0 ? r0(totalWeight).toLocaleString() : '';

      if(totalWeight>0 && envelopePts.length>0){
        const limits = interpolateEnvelope(totalWeight);
        if(limits){
          const fwd = r1(limits.fwd), aft = r1(limits.aft);
          envFwdEl.value = fwd.toFixed(1);
          envAftEl.value = aft.toFixed(1);

          if(loadCB===0){
            envBadge.innerHTML = `<span class="pill warn">No Load CB yet</span>`;
          } else if(loadCB < fwd){
            envBadge.innerHTML = `<span class="pill bad">FORWARD of limit ‚Äî Load CB ${r1(loadCB).toFixed(1)} &lt; FS ${fwd.toFixed(1)}</span>`;
          } else if(loadCB > aft){
            envBadge.innerHTML = `<span class="pill bad">AFT of limit ‚Äî Load CB ${r1(loadCB).toFixed(1)} &gt; FS ${aft.toFixed(1)}</span>`;
          } else {
            envBadge.innerHTML = `<span class="pill ok">WITHIN ENVELOPE ‚Äî Load CB ${r1(loadCB).toFixed(1)} between FS ${fwd.toFixed(1)} and FS ${aft.toFixed(1)}</span>`;
          }
        } else {
          envFwdEl.value = ''; envAftEl.value = '';
          envBadge.innerHTML = `<span class="pill warn">Payload outside your entered envelope points ‚Äî add more data</span>`;
        }
      } else {
        envFwdEl.value = ''; envAftEl.value = '';
        envBadge.innerHTML = '';
      }
    }

    // Recalc when operating values change
    ['opWeight','opMom10k'].forEach(id => {
      document.getElementById(id).addEventListener('input', recalc);
    });

    // Init
    seedEnvelope();
    addRow(); addRow(); addRow();
    recalc();
  </script>
</body>
</html>