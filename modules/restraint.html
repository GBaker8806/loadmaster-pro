<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="../style.css" />
  <script src="../common.js" defer></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Restraint Calculator</title>
</head>
<body>
  <button onclick="goHome()" class="home-button">üè† Home</button>

  <h1>Restraint Calculator</h1>

  <label for="cargoWeight">Cargo Weight (lbs):</label>
  <input
    inputmode="numeric"
    pattern="[0-9]*"
    class="form-control"
    id="cargoWeight"
    placeholder="e.g., 12000"
  />

  <button onclick="calculateRestraint()">Calculate Required Restraint</button>
  <div id="result"></div>

  <hr style="margin: 2rem 0; border-color: #444;" />

  <h2>Actual Restraint Calculator</h2>

  <label for="restraintDirection">Direction:</label>
  <select id="restraintDirection" onchange="toggleAngleInputs()">
    <option value="FWD">FWD</option>
    <option value="AFT">AFT</option>
    <option value="LAT">LAT</option>
    <option value="VERT">VERT</option>
  </select>

  <!-- LAT-only angle inputs (hidden unless Direction = LAT) -->
  <div id="angleInputs" style="display:none; margin-top: .75rem;">
    <label for="leftAngle">Left Lateral Angle (deg):</label>
    <input
      inputmode="decimal"
      pattern="[0-9.]*"
      class="form-control"
      id="leftAngle"
      placeholder="e.g., 30"
    />
    <label for="rightAngle">Right Lateral Angle (deg):</label>
    <input
      inputmode="decimal"
      pattern="[0-9.]*"
      class="form-control"
      id="rightAngle"
      placeholder="e.g., 30"
    />
    <p class="muted" style="margin-top:.25rem">
      LAT restraint is computed as the sum of the left/right components:
      <code>component = base √ó cos(angle)</code>
    </p>
  </div>

  <label for="actualLength">Actual Length (in):</label>
  <input
    inputmode="numeric"
    pattern="[0-9]*"
    class="form-control"
    id="actualLength"
    placeholder="e.g., 100"
  />

  <label for="effectiveLength">Effective Length (in):</label>
  <input
    inputmode="numeric"
    pattern="[0-9]*"
    class="form-control"
    id="effectiveLength"
    placeholder="e.g., 80"
  />

  <label for="restraintFactor">Restraint Factor:</label>
  <select id="restraintFactor">
    <option value="5000">5,000 lbs</option>
    <option value="10000" selected>10,000 lbs</option>
    <option value="25000">25,000 lbs</option>
  </select>

  <div style="text-align: center;">
    <button id="multiplierToggle" onclick="toggleMultiplier()">√ó2 OFF</button>
  </div>

  <button onclick="calculateActualRestraint()">Calculate Actual Restraint</button>
  <button onclick="clearAll()" style="margin-top: 2rem; background-color: #b44444;">Clear All</button>

  <script>
    // Home helper (kept in case common.js isn't loaded for some reason)
    function goHome() { window.location.href = "../index.html"; }

    let requiredRestraint = {};
    let totalRestraint = { FWD: 0, AFT: 0, LAT: 0, VERT: 0 };
    let requiredText = "";
    let doubleMultiplier = false;

    function toggleMultiplier() {
      doubleMultiplier = !doubleMultiplier;
      const btn = document.getElementById("multiplierToggle");
      btn.innerText = doubleMultiplier ? "√ó2 ON" : "√ó2 OFF";
      btn.classList.toggle("active", doubleMultiplier);
    }

    function toggleAngleInputs() {
      const direction = document.getElementById("restraintDirection").value;
      const box = document.getElementById("angleInputs");
      if (box) box.style.display = (direction === "LAT") ? "block" : "none";
    }

    function displayTotals(baseText) {
      let result = (baseText || "") + (baseText ? "\n\n" : "") + "Current Actual Totals:";
      for (const dir in totalRestraint) {
        result += `   ${dir}: ${totalRestraint[dir]} lbs   |`;
      }
      return result.slice(0, -1);
    }

    function calculateRestraint() {
      const weight = parseFloat(document.getElementById("cargoWeight").value);
      if (isNaN(weight) || weight <= 0) {
        document.getElementById("result").innerText = "Enter a valid cargo weight.";
        return;
      }
      const gForces = { FWD: 3.0, AFT: 1.5, LAT: 1.5, VERT: 2.0 };
      requiredRestraint = {};
      requiredText = `Required Restraint Forces for ${weight} lbs:`;
      for (const dir in gForces) {
        const force = Math.round(weight * gForces[dir]);
        requiredRestraint[dir] = force;
        requiredText += `\n${dir}: ${force} lbs`;
      }
      document.getElementById("result").innerText = displayTotals(requiredText);
    }

    function calculateActualRestraint() {
      const actual = parseFloat(document.getElementById("actualLength").value);
      const effective = parseFloat(document.getElementById("effectiveLength").value);
      const factor = parseFloat(document.getElementById("restraintFactor").value);
      const direction = document.getElementById("restraintDirection").value;

      if (isNaN(actual) || actual <= 0 || isNaN(effective) || effective <= 0) {
        document.getElementById("result").innerText += `\n\n‚ö†Ô∏è Enter valid actual and effective lengths.`;
        return;
      }

      let baseRestraint = (effective / actual) * factor;
      if (doubleMultiplier) baseRestraint *= 2;

      let total = 0;
      if (direction === "LAT") {
        // Safe lookup of optional angle inputs
        const leftEl = document.getElementById("leftAngle");
        const rightEl = document.getElementById("rightAngle");
        const left = leftEl ? parseFloat(leftEl.value) : NaN;
        const right = rightEl ? parseFloat(rightEl.value) : NaN;

        if (!isNaN(left))  total += baseRestraint * Math.cos((left  * Math.PI) / 180);
        if (!isNaN(right)) total += baseRestraint * Math.cos((right * Math.PI) / 180);
      } else {
        total = baseRestraint;
      }

      totalRestraint[direction] += Math.round(total);
      document.getElementById("result").innerText = displayTotals(requiredText || "");
    }

    function clearAll() {
      document.getElementById("cargoWeight").value = "";
      document.getElementById("actualLength").value = "";
      document.getElementById("effectiveLength").value = "";
      document.getElementById("restraintFactor").value = "10000";
      document.getElementById("restraintDirection").value = "FWD";

      const leftEl = document.getElementById("leftAngle");
      const rightEl = document.getElementById("rightAngle");
      if (leftEl) leftEl.value = "";
      if (rightEl) rightEl.value = "";

      toggleAngleInputs();

      totalRestraint = { FWD: 0, AFT: 0, LAT: 0, VERT: 0 };
      requiredRestraint = {};
      requiredText = "";
      doubleMultiplier = false;

      const btn = document.getElementById("multiplierToggle");
      btn.innerText = "√ó2 OFF";
      btn.classList.remove("active");

      document.getElementById("result").innerText = "";
    }

    // Initialize UI state on load
    document.addEventListener("DOMContentLoaded", toggleAngleInputs);
  </script>
</body>
</html>